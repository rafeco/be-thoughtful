{% extends "base.html" %}

{% block title %}Dashboard - Be Thoughtful{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1>Dashboard</h1>
        <p class="lead">Planning for Christmas {{ active_year }}</p>
    </div>
</div>

<!-- Current Phase -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header bg-primary text-white">
                <h5 class="mb-0">Current Phase: {{ current_phase }}</h5>
            </div>
            <div class="card-body">
                {% if current_phase == 'Pre-planning' %}
                    <p class="mb-3">Get ready for Christmas {{ active_year }}! The planning cycle starts in September.</p>
                    <h6 class="mb-2">Pre-planning suggestions:</h6>
                    <ul class="mb-0">
                        <li class="mb-2">Review and update your contact list - add new people, mark anyone who moved or changed roles</li>
                        <li class="mb-2">Log gift ideas as you think of them throughout the year</li>
                        <li class="mb-2">Review last year's archive to see what worked well and what to improve</li>
                        <li class="mb-2">Note any budget changes or new family traditions</li>
                        <li class="mb-2">Keep track of interests and preferences people mention</li>
                    </ul>
                {% elif current_milestone and current_milestone.subtasks %}
                    <p class="mb-3">{{ current_milestone.description }}</p>
                    <h6 class="mb-2">Tasks for this month:</h6>
                    <ul class="list-unstyled">
                        {% for subtask in current_milestone.subtasks %}
                        <li class="mb-2">
                            <div class="form-check">
                                <input class="form-check-input subtask-checkbox"
                                       type="checkbox"
                                       data-milestone-id="{{ current_milestone.id }}"
                                       data-subtask-index="{{ loop.index0 }}"
                                       {% if current_milestone.completed_subtasks and loop.index0 in current_milestone.completed_subtasks %}checked{% endif %}>
                                <label class="form-check-label">
                                    {{ subtask }}
                                </label>
                            </div>
                        </li>
                        {% endfor %}
                    </ul>
                {% else %}
                    {% if current_phase == 'September' %}
                        <p>Brainstorm gifts and draft your card list. Start capturing gift ideas!</p>
                    {% elif current_phase == 'October' %}
                        <p>Purchase gifts for family members and order physical cards.</p>
                    {% elif current_phase == 'November' %}
                        <p>Write handwritten cards and buy colleague gifts.</p>
                    {% elif current_phase == 'December' %}
                        <p>Distribute colleague gifts, send e-cards, and wrap everything!</p>
                    {% endif %}
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Stats Row -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <a href="{{ url_for('people_list') }}" class="text-decoration-none">
                    <h2 class="text-primary">{{ total_people }}</h2>
                </a>
                <p class="mb-0">Total People</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <a href="{{ url_for('people_list', gift='yes') }}" class="text-decoration-none">
                    <h2 class="text-success">{{ people_with_gifts }}</h2>
                </a>
                <p class="mb-0">Getting Gifts</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <a href="{{ url_for('people_list', card='Handwritten') }}" class="text-decoration-none">
                    <h2 class="text-info">{{ handwritten_count }}</h2>
                </a>
                <p class="mb-0">Handwritten Cards</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center">
            <div class="card-body">
                <a href="{{ url_for('people_list', card='E-card') }}" class="text-decoration-none">
                    <h2 class="text-warning">{{ ecard_count }}</h2>
                </a>
                <p class="mb-0">E-cards</p>
            </div>
        </div>
    </div>
</div>

<!-- Progress Row -->
{% if current_phase != 'Pre-planning' %}
<div class="row mb-4">
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6>Milestone Progress</h6>
                <div class="progress">
                    <div class="progress-bar" role="progressbar" style="width: {{ milestone_progress }}%">
                        {{ "%.0f"|format(milestone_progress) }}%
                    </div>
                </div>
                <small class="text-muted">{{ milestones|selectattr('completed')|list|length }} of {{ milestones|length }} completed</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6>Gifts Purchased</h6>
                <div class="progress">
                    {% set gift_progress = (gift_tasks_completed / people_with_gifts * 100) if people_with_gifts > 0 else 0 %}
                    <div class="progress-bar bg-success" role="progressbar" style="width: {{ gift_progress }}%">
                        {{ "%.0f"|format(gift_progress) }}%
                    </div>
                </div>
                <small class="text-muted">{{ gift_tasks_completed }} of {{ people_with_gifts }} purchased</small>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h6>Cards Written</h6>
                <div class="progress">
                    {% set total_cards = handwritten_count + ecard_count %}
                    {% set card_progress = (cards_written / total_cards * 100) if total_cards > 0 else 0 %}
                    <div class="progress-bar bg-info" role="progressbar" style="width: {{ card_progress }}%">
                        {{ "%.0f"|format(card_progress) }}%
                    </div>
                </div>
                <small class="text-muted">{{ cards_written }} of {{ total_cards }} completed</small>
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Milestones -->
<div class="row mb-4">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Milestones for {{ active_year }}</h5>
            </div>
            <div class="card-body">
                {% if current_phase == 'Pre-planning' %}
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i> These milestones will become active when September arrives. Use this time to prepare!
                </div>
                {% endif %}
                <div class="list-group">
                    {% for milestone in milestones %}
                    <div class="list-group-item {% if milestone.completed %}list-group-item-success{% endif %}">
                        <div class="d-flex justify-content-between align-items-center milestone-header {% if milestone.subtasks %}clickable{% endif %}"
                             {% if milestone.subtasks %}data-bs-toggle="collapse" data-bs-target="#milestone-{{ milestone.id }}-tasks"{% endif %}>
                            <div class="flex-grow-1">
                                <i class="bi {% if milestone.completed %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} milestone-icon me-2"
                                   data-milestone-id="{{ milestone.id }}"></i>
                                <strong>{{ milestone.phase }}</strong>: {{ milestone.description }}
                                {% if milestone.completed and milestone.completed_date %}
                                    <br><small class="text-success ms-4">Completed {{ milestone.completed_date }}</small>
                                {% endif %}
                            </div>
                            {% if milestone.subtasks %}
                            <button class="btn btn-sm btn-outline-secondary milestone-toggle" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#milestone-{{ milestone.id }}-tasks"
                                    aria-expanded="false"
                                    onclick="event.stopPropagation()">
                                <i class="bi bi-chevron-down"></i>
                            </button>
                            {% endif %}
                        </div>

                        <!-- Collapsible Subtasks (Read-only) -->
                        {% if milestone.subtasks %}
                        <div class="collapse mt-3" id="milestone-{{ milestone.id }}-tasks">
                            <div class="ms-4">
                                <h6 class="text-muted small">Tasks:</h6>
                                <ul class="list-unstyled mb-0">
                                    {% for subtask in milestone.subtasks %}
                                    <li class="mb-2">
                                        <i class="bi {% if milestone.completed_subtasks and loop.index0 in milestone.completed_subtasks %}bi-check-circle-fill text-success{% else %}bi-circle text-muted{% endif %} subtask-icon me-2"
                                           data-milestone-id="{{ milestone.id }}"
                                           data-subtask-index="{{ loop.index0 }}"></i>
                                        <span class="text-muted">{{ subtask }}</span>
                                    </li>
                                    {% endfor %}
                                </ul>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Quick Actions -->
<div class="row">
    <div class="col-md-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Quick Actions</h5>
            </div>
            <div class="card-body">
                <a href="{{ url_for('people_list') }}" class="btn btn-primary me-2">
                    <i class="bi bi-people"></i> View All People
                </a>
                <a href="{{ url_for('shopping_list') }}" class="btn btn-success me-2">
                    <i class="bi bi-bag"></i> Shopping List
                </a>
                <a href="{{ url_for('writing_queue') }}" class="btn btn-info me-2">
                    <i class="bi bi-pen"></i> Writing Queue
                </a>
                <a href="{{ url_for('person_new') }}" class="btn btn-outline-primary">
                    <i class="bi bi-plus-circle"></i> Add Person
                </a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Subtask checkbox toggling on dashboard (Current Phase section only)
    const subtaskCheckboxes = document.querySelectorAll('.subtask-checkbox');
    subtaskCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', async function() {
            const milestoneId = this.dataset.milestoneId;
            const subtaskIndex = parseInt(this.dataset.subtaskIndex);

            try {
                const response = await fetch(`/milestones/${milestoneId}/toggle-subtask`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ subtask_index: subtaskIndex })
                });

                if (response.ok) {
                    const data = await response.json();

                    // Update milestone icon if auto-completed
                    const milestoneIcon = document.querySelector(`.milestone-icon[data-milestone-id="${milestoneId}"]`);
                    if (milestoneIcon) {
                        if (data.milestone_completed) {
                            milestoneIcon.classList.remove('bi-circle', 'text-muted');
                            milestoneIcon.classList.add('bi-check-circle-fill', 'text-success');
                        } else {
                            milestoneIcon.classList.remove('bi-check-circle-fill', 'text-success');
                            milestoneIcon.classList.add('bi-circle', 'text-muted');
                        }
                    }

                    // Update corresponding subtask icon in Milestones section below
                    const subtaskIcon = document.querySelector(`.subtask-icon[data-milestone-id="${milestoneId}"][data-subtask-index="${subtaskIndex}"]`);
                    if (subtaskIcon) {
                        if (this.checked) {
                            subtaskIcon.classList.remove('bi-circle', 'text-muted');
                            subtaskIcon.classList.add('bi-check-circle-fill', 'text-success');
                        } else {
                            subtaskIcon.classList.remove('bi-check-circle-fill', 'text-success');
                            subtaskIcon.classList.add('bi-circle', 'text-muted');
                        }
                    }

                    // Update list item styling (only in the milestones section)
                    const listItem = document.querySelector(`.milestone-icon[data-milestone-id="${milestoneId}"]`)?.closest('.list-group-item');
                    if (listItem) {
                        if (data.milestone_completed) {
                            listItem.classList.add('list-group-item-success');
                        } else {
                            listItem.classList.remove('list-group-item-success');
                        }
                    }
                } else {
                    alert('Failed to update subtask');
                    this.checked = !this.checked; // Revert
                }
            } catch (error) {
                console.error('Error updating subtask:', error);
                alert('Failed to update subtask');
                this.checked = !this.checked; // Revert
            }
        });
    });

    // Rotate chevron on collapse toggle
    const milestoneHeaders = document.querySelectorAll('.milestone-header.clickable');
    milestoneHeaders.forEach(header => {
        const targetId = header.dataset.bsTarget;
        const target = document.querySelector(targetId);
        const chevronButton = header.querySelector('.milestone-toggle');

        if (target && chevronButton) {
            target.addEventListener('show.bs.collapse', function() {
                chevronButton.querySelector('i').classList.remove('bi-chevron-down');
                chevronButton.querySelector('i').classList.add('bi-chevron-up');
            });
            target.addEventListener('hide.bs.collapse', function() {
                chevronButton.querySelector('i').classList.remove('bi-chevron-up');
                chevronButton.querySelector('i').classList.add('bi-chevron-down');
            });
        }
    });
});
</script>
{% endblock %}
